services:
  couchdb:
    image: $IMAGE_NAMESPACE/${IMAGE_DEPENDENCY_PREFIX}couchdb:$COUCHDB_TAG
    restart: $RESTART_MODE
    environment:
      COUCHDB_USER: arsnova
      COUCHDB_PASSWORD: arsnova
    volumes:
      - couchdb_data:/opt/couchdb/data
  postgresql-authz:
    image: postgres:18.1-alpine@sha256:b40d931bd0e7ce6eecc59a5a6ac3b3c04a01e559750e73e7086b6dbd7f8bf545
    restart: $RESTART_MODE
    environment:
      POSTGRES_DB: arsnovaauth
      POSTGRES_USER: arsnovaauth
      POSTGRES_PASSWORD: arsnovaauth
    volumes:
      - postgresql_data_auth:/var/lib/postgresql
  postgresql-comments:
    image: postgres:18.1-alpine@sha256:b40d931bd0e7ce6eecc59a5a6ac3b3c04a01e559750e73e7086b6dbd7f8bf545
    restart: $RESTART_MODE
    environment:
      POSTGRES_DB: arsnovacomment
      POSTGRES_USER: arsnovacomment
      POSTGRES_PASSWORD: arsnovacomment
    volumes:
      - postgresql_data_comment:/var/lib/postgresql
  rabbitmq:
    image: $IMAGE_NAMESPACE/${IMAGE_DEPENDENCY_PREFIX}rabbitmq-stomp:$RABBITMQ_TAG
    restart: $RESTART_MODE
    environment:
      RABBITMQ_NODENAME: rabbit@localhost
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
  arsnova-server-core:
    image: $IMAGE_NAMESPACE/${IMAGE_SERVER_PREFIX}core:$CORE_TAG
    restart: $RESTART_MODE
    depends_on:
      - couchdb
      - rabbitmq
    environment:
      SYSTEM_API_PROXYPATH: /api
      SYSTEM_COUCHDB_HOST: couchdb
      SYSTEM_COUCHDB_USERNAME: arsnova
      SYSTEM_COUCHDB_PASSWORD: arsnova
      SYSTEM_COUCHDB_CREATEDB: "true"
      SYSTEM_COUCHDB_MIGRATION_ENABLED: "true"
      SYSTEM_COUCHDB_MIGRATION_HOST: couchdb-import
      SYSTEM_COUCHDB_MIGRATION_USERNAME: arsnova
      SYSTEM_COUCHDB_MIGRATION_PASSWORD: arsnova
      SYSTEM_MESSAGE_BROKER_RABBITMQ_ENABLED: "true"
      SYSTEM_MESSAGE_BROKER_RABBITMQ_HOST: rabbitmq
      SYSTEM_MESSAGE_BROKER_RABBITMQ_USERNAME: guest
      SYSTEM_MESSAGE_BROKER_RABBITMQ_PASSWORD: guest
      SYSTEM_MESSAGE_BROKER_RABBITMQ_VIRTUAL_HOST: /
      SYSTEM_MAIL_LOCALHOST: $ARSNOVA_HOSTNAME
      SYSTEM_FORMATTING_SERVICE_HOST_URL: http://arsnova-server-formatting:3000
      SECURITY_JWT_SECRET: $JWT_SECRET
      SECURITY_JWT_SERVER_ID: arsnova.backend.v3:$JWT_DOMAIN
  arsnova-server-websocket:
    image: $IMAGE_NAMESPACE/${IMAGE_SERVER_PREFIX}websocket:$WEBSOCKET_TAG
    restart: $RESTART_MODE
    depends_on:
      - rabbitmq
      - arsnova-server-authz
    environment:
      SERVER_PORT: 8080
      STOMP_RELAY_HOST: rabbitmq
      STOMP_RELAY_USER: guest
      STOMP_RELAY_PASSWORD: guest
      HTTP_CLIENT_AUTH_SERVICE: http://arsnova-server-authz:8080
      SECURITY_JWT_SECRET: $JWT_SECRET
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
  arsnova-server-authz:
    image: $IMAGE_NAMESPACE/${IMAGE_SERVER_PREFIX}authz:$AUTHZ_TAG
    restart: $RESTART_MODE
    depends_on:
      - postgresql-authz
      - rabbitmq
    environment:
      SERVER_PORT: 8080
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql-authz:5432/arsnovaauth
      SPRING_DATASOURCE_USERNAME: arsnovaauth
      SPRING_DATASOURCE_PASSWORD: arsnovaauth
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      SECURITY_JWT_SECRET: $JWT_SECRET
      SECURITY_JWT_SERVER_ID: arsnova.backend.v3:$JWT_DOMAIN
  arsnova-server-comments:
    image: $IMAGE_NAMESPACE/${IMAGE_SERVER_PREFIX}comments:$COMMENTS_TAG
    restart: $RESTART_MODE
    depends_on:
      - postgresql-comments
      - rabbitmq
    environment:
      SERVER_PORT: 8080
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql-comments:5432/arsnovacomment
      SPRING_DATASOURCE_USERNAME: arsnovacomment
      SPRING_DATASOURCE_PASSWORD: arsnovacomment
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      SECURITY_JWT_SECRET: $JWT_SECRET
  arsnova-webclient:
    image: $IMAGE_NAMESPACE/arsnova-webclient:$WEBCLIENT_TAG
    restart: $RESTART_MODE
  arsnova-server-formatting:
    image: $IMAGE_NAMESPACE/${IMAGE_SERVER_PREFIX}formatting:$FORMATTING_TAG
    restart: $RESTART_MODE
    environment:
      SERVER_PORT: 3000

volumes:
  couchdb_data:
  postgresql_data_auth:
  postgresql_data_comment:
  rabbitmq_data:
